<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Londiste on Blog do Seba</title>
    <link>http://swebber.me/categories/londiste/index.xml</link>
    <description>Recent content in Londiste on Blog do Seba</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <managingEditor>sebastian@swebber.me (Sebastian Webber)</managingEditor>
    <webMaster>sebastian@swebber.me (Sebastian Webber)</webMaster>
    <copyright>This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License.</copyright>
    <atom:link href="http://swebber.me/categories/londiste/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Trabalhando com o londiste</title>
      <link>http://swebber.me/blog/2014/04/25/trabalhando-com-o-londiste/</link>
      <pubDate>Fri, 25 Apr 2014 14:33:00 -0300</pubDate>
      <author>sebastian@swebber.me (Sebastian Webber)</author>
      <guid>http://swebber.me/blog/2014/04/25/trabalhando-com-o-londiste/</guid>
      <description>

&lt;p&gt;Este post é um complemento para o post que cita a instalação e configuração do Londiste. Vou atualizar este post conforme possível.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;É importante lembrar que a citação &lt;code&gt;[CON_STR]&lt;/code&gt; quer dizer a string de conexão utilizada, seguindo o padrão utilizado pela libpq.&lt;/p&gt;

&lt;p&gt;Para simplificar a configuração, ao citar o arquivo de configuração, vou sempre utilizar o arquivo &lt;code&gt;/etc/londiste/config.ini&lt;/code&gt;, mas lembre é necessário criar um arquivo separado para cada job.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;string-de-conexão&#34;&gt;String de conexão&lt;/h2&gt;

&lt;p&gt;A string de conexão é detalhada na documentação oficial, conforme abaixo:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Sintaxe:&lt;/strong&gt; &lt;a href=&#34;http://www.postgresql.org/docs/9.2/static/libpq-connect.html#LIBPQ-CONNSTRING&#34;&gt;http://www.postgresql.org/docs/9.2/static/libpq-connect.html#LIBPQ-CONNSTRING&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Opções:&lt;/strong&gt; &lt;a href=&#34;http://www.postgresql.org/docs/9.2/static/libpq-connect.html#LIBPQ-PARAMKEYWORDS&#34;&gt;http://www.postgresql.org/docs/9.2/static/libpq-connect.html#LIBPQ-PARAMKEYWORDS&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemplo:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;host=localhost port=5432 dbname=mydb connect_timeout=10
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;manutenção-dos-nós&#34;&gt;Manutenção dos nós&lt;/h2&gt;

&lt;h3 id=&#34;adicionando-e-removendo-nós&#34;&gt;Adicionando e removendo nós&lt;/h3&gt;

&lt;p&gt;Para adicionar o nó tipo &lt;code&gt;root&lt;/code&gt; (master da replicação):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/config.ini create-root nome_node &amp;quot;[CON_STR]&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Para adicionar nós tipo &lt;code&gt;branch&lt;/code&gt; ou &lt;code&gt;leaf&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/config.ini create-XXXXX nome_node &amp;quot;[CON_STR_DESTINO]&amp;quot; --provider=&amp;quot;[CON_STR_ROOT]&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;Aonde &lt;code&gt;XXXXX&lt;/code&gt; é o tipo de nó (branch ou leaf)&lt;/p&gt;

&lt;p&gt;&lt;code&gt;[CON_STR_DESTINO]&lt;/code&gt; é a string de conexão do servidor que será o nó (slave)&lt;/p&gt;

&lt;p&gt;&lt;code&gt;[CON_STR_ROOT]&lt;/code&gt; é a string de conexão do servidor que será o root (master)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Para remover o nó:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/config.ini drop-node nome_node
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;iniciando-e-parando-o-daemon&#34;&gt;Iniciando e parando o daemon&lt;/h3&gt;

&lt;p&gt;Para iniciar:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/config.ini -d worker
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Para parar:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/config.ini --stop
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;Para forçar a parada do mesmo, substitua o &lt;code&gt;\-\-stop&lt;/code&gt; por &lt;code&gt;\-\-kill&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;trabalhando-com-tabelas&#34;&gt;Trabalhando com tabelas&lt;/h2&gt;

&lt;p&gt;Cada operação é específica para cada nó.&lt;/p&gt;

&lt;h3 id=&#34;adicionando-e-removendo-tabelas&#34;&gt;Adicionando e removendo tabelas&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;a opção &lt;code&gt;\-\-all&lt;/code&gt; pode ser utilizada para aplicar a operação em todos os objetos&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Para adicionar:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/config.ini add-table nome_tabela
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Para remover:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/config.ini remove-table nome_tabela
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;listando-objetos-replicadas&#34;&gt;Listando objetos replicadas&lt;/h3&gt;

&lt;p&gt;Para listar as tabelas:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/config.ini tables
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Para listar as sequências:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/config.ini seqs
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;listando-objetos-disponíveis-para-replicação&#34;&gt;Listando objetos disponíveis para replicação&lt;/h3&gt;

&lt;p&gt;O comando a baixo necessáriamente precisa ser executado em um nó slave (leaf ou branch).&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/config.ini missing
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;listando-status-da-replicação&#34;&gt;Listando status da replicação&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/config.ini status
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Utilizando o Londiste 3 com o PostgreSQL 8.4</title>
      <link>http://swebber.me/blog/2014/04/24/utilizando-o-londiste-3-com-o-postgresql-8-dot-4/</link>
      <pubDate>Thu, 24 Apr 2014 18:34:52 -0300</pubDate>
      <author>sebastian@swebber.me (Sebastian Webber)</author>
      <guid>http://swebber.me/blog/2014/04/24/utilizando-o-londiste-3-com-o-postgresql-8-dot-4/</guid>
      <description>&lt;p&gt;Devido ao pacote do skytools não estar disponível no repositório oficial do pgdg, é necessário compilar o mesmo.&lt;/p&gt;

&lt;p&gt;Instale os pacotes necessários:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;yum install gcc make libtool git python-devel python-psycopg2 asciidoc xmlto cpp
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Baixe o skytools do git e instale-o:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mkdir /opt/resources
git clone https://github.com/markokr/skytools.git /opt/resources/skytools
cd /opt/resources/skytools/
git submodule init
git submodule update
./autogen.sh
./configure --prefix=/usr/local/skytools
make
make install
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Referências:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/markokr/skytools/blob/master/INSTALL&#34;&gt;https://github.com/markokr/skytools/blob/master/INSTALL&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>Replicação lógica com o Londiste</title>
      <link>http://swebber.me/blog/2014/04/18/replicacao-logica-com-o-londiste/</link>
      <pubDate>Fri, 18 Apr 2014 18:38:04 -0300</pubDate>
      <author>sebastian@swebber.me (Sebastian Webber)</author>
      <guid>http://swebber.me/blog/2014/04/18/replicacao-logica-com-o-londiste/</guid>
      <description>

&lt;p&gt;O objetivo desse post é implementar o londiste, que é uma ferramenta de replicação assincrona do tipo master/slave e faz parte do pacote de ferramentas SkyTools.&lt;/p&gt;

&lt;p&gt;Pontos a validar dessa solução:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Tempo de replicação dos dados&lt;/li&gt;
&lt;li&gt;Tipos de dados suportados, em especial:

&lt;ul&gt;
&lt;li&gt;Sequence&lt;/li&gt;
&lt;li&gt;Timestamp&lt;/li&gt;
&lt;li&gt;Bytea&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;sobre-o-ambiente-de-testes&#34;&gt;Sobre o ambiente de testes&lt;/h2&gt;

&lt;p&gt;O ambiente de testes é composto por 2 servidores linux conforme abaixo:&lt;/p&gt;

&lt;table class=&#34;table&#34;&gt;
    &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;/th&gt;
        &lt;th&gt;Master&lt;/th&gt;
        &lt;th&gt;Slave&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;Hostname&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;pg-master&lt;/td&gt;
            &lt;td&gt;pg-slave&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;SO&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;CEntOS 6.5&lt;/td&gt;
            &lt;td&gt;CEntOS 6.5&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;PostgreSQL&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;9.3.4&lt;/td&gt;
            &lt;td&gt;9.3.4&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;Skytools&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;3.1.5&lt;/td&gt;
            &lt;td&gt;3.1.5&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;IP&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;192.168.152.149&lt;/td&gt;
            &lt;td&gt;192.168.152.150&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&#34;instalação-do-postgresql&#34;&gt;Instalação do PostgreSQL&lt;/h2&gt;

&lt;p&gt;Processo necessário em ambos os servidores.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cd /tmp
wget -c http://yum.postgresql.org/9.3/redhat/rhel-6-x86_64/pgdg-centos93-9.3-1.noarch.rpm
yum localinstall pgdg-centos93-9.3-1.noarch.rpm
yum install postgresql93-server postgresql93-contrib
service postgresql-9.3 initdb
chkconfig postgresql-9.3 on
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;ajustes-no-firewall&#34;&gt;Ajustes no firewall&lt;/h3&gt;

&lt;p&gt;Executar apenas no servidor master:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;iptables -I INPUT -p tcp --dport 5432 -s 192.168.152.149 -j ACCEPT
service iptables save
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;Nesse lab não foi necessário parar ou ajustar o SELinux.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;ajustes-no-postgresql-conf&#34;&gt;Ajustes no postgresql.conf&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;listen_addresses = &#39;*&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;ajustes-na-configuração-do-pg-hba-conf&#34;&gt;Ajustes na configuração do pg_hba.conf&lt;/h3&gt;

&lt;p&gt;Por questão de conveniência, libere acesso a todos os bancos dos servidores citados:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;host    all   postgres    192.168.152.149/32  trust
host    all   postgres    192.168.152.150/32  trust
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Agora inicie o postgresql:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;service postgresql-9.3 start
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;sobre-o-londiste&#34;&gt;Sobre o Londiste&lt;/h2&gt;

&lt;p&gt;O Londiste é uma ferramenta escrita em python, que utiliza o PgQ para o gerenciamento de eventos.&lt;/p&gt;

&lt;p&gt;O PgQ que é um sistema de filas escrito em PL/pgSQL. Ele é divido em 3 principais funcionalidades:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Producers:&lt;/strong&gt; coloca eventos em uma determinada fila&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Ticker:&lt;/strong&gt; é um daemon que separa as filas em pacotes de eventos&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Consumers:&lt;/strong&gt; lê eventos de uma determinada fila&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Quanto à replicação do londiste, a mesma é controlada pelos nós (nodes), que são classicados como:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;b&gt;root:&lt;/b&gt; é o servidor master da replicação&lt;/li&gt;
&lt;li&gt;&lt;b&gt;branch:&lt;/b&gt; é o servidor slave da replicação e permite que outros nós o utilizem para replica de dados em cascata&lt;/li&gt;
&lt;li&gt;&lt;b&gt;leaf:&lt;/b&gt; é o servidor slave da replicação e não permite replicação apartir dele&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Na prática, cada configuração do nó é um job para processar as filas do PgQ. Para manter as filas atualizadas, um daemon chamado de worker é executado. Varios workers podem ser executados simulâneamente.&lt;/p&gt;

&lt;p&gt;O daemon do PgQ, diferente do worker, precisa ter acesso a todos os bancos, para procupar pelos jobs e manter as filas e é por isso que sua string de conexão é parcial (parâmetro &lt;code&gt;base_connstr&lt;/code&gt;). Seu acesso padrão é realizado ao banco &lt;code&gt;template1&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Recomendo que o daemon do PgQ seja executado do servidor que for o nó root (master) mas nada impede de o mesmo ficar em um servidor isolado.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;É importante lembrar que a solução do Londiste é implementada através de triggers nas tabelas replicadas e isso gera 2 ações necessárias: obrigatoriedade de mesma estrutura de tabelas/colunas e criação de constraints tipo PK e FK nos objetos replicados.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;instalação-do-londiste&#34;&gt;Instalação do Londiste&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;yum install skytools-93 skytools-93-modules
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Talvez seja necessário reiniciar o postgresql nesse ponto.&lt;/p&gt;

&lt;h2 id=&#34;configuração-do-londiste&#34;&gt;Configuração do londiste&lt;/h2&gt;

&lt;p&gt;Crie a estrutura de dados em ambos os servidores:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;psql -U postgres -f schema_londiste.sql
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-sql&#34;&gt;-- criação do banco de dados
CREATE DATABASE teste_replica;

\c teste_replica

-- estrutura de dados
CREATE TABLE pessoa (
    id SERIAL PRIMARY KEY,
    nome TEXT NOT NULL,
    data_nascimento DATE NOT NULL,
    ultima_visita TIMESTAMP NOT NULL DEFAULT now(),
    foto BYTEA,
    biografia TEXT
);

-- funções de apoio
CREATE OR REPLACE FUNCTION bytea_import(p_path text, p_result out bytea) 
                   LANGUAGE plpgsql as $$
DECLARE
  l_oid oid;
  r record;
BEGIN
  p_result := &#39;&#39;;
  select lo_import(p_path) into l_oid;
  for r in ( select data 
             from pg_largeobject 
             where loid = l_oid 
             order by pageno ) loop
    p_result = p_result || r.data;
  end loop;
  perform lo_unlink(l_oid);
END;
$$;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;servidor-master&#34;&gt;Servidor master&lt;/h3&gt;

&lt;p&gt;Crie os diretórios necessários:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mkdir {/etc,/var/log,/var/run}/londiste
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Crie o arquivo &lt;code&gt;/etc/londiste/teste_replica_root.ini&lt;/code&gt;, com o conteúdo abaixo:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[londiste3]
job_name = teste_replica_root
db = dbname=teste_replica host=192.168.152.149 user=postgres
queue_name = q_teste_replica
logfile = /var/log/londiste/teste_replica_root.log
pidfile = /var/run/londiste/teste_replica_root.pid
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Quanto aos parâmetros utilizados:&lt;/p&gt;

&lt;table class=&#34;table table-bordered&#34;&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;Propriedade&lt;/th&gt;
            &lt;th&gt;Descrição&lt;/th&gt;
            &lt;th&gt;Sugestão de valores&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;job_name&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;Nome do Job a ser executado&lt;/td&gt;
            &lt;td&gt;&lt;pre&gt;[NOME_BANCO]_[TIPO_NODE]&lt;/pre&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;db&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;Connection String com detalhes de conexão do banco replicado&lt;/td&gt;
            &lt;td&gt;&lt;pre&gt;host=[PGHOST] port=[PGPORT] dbname=[NOME_BANCO] user=[PGUSER]&lt;/pre&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;queue_name&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;Nome da fila&lt;/td&gt;
            &lt;td&gt;&lt;pre&gt;q_[NOME_BANCO]&lt;/pre&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;logfile&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;Caminho completo do arquivo de log&lt;/td&gt;
            &lt;td&gt;&lt;pre&gt;/var/log/londiste/[NOME_BANCO]_[TIPO_NODE].log&lt;/pre&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;pidfile&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;Caminho completo do arquivo pid do worker&lt;/td&gt;
            &lt;td&gt;&lt;pre&gt;/var/run/londiste/[NOME_BANCO]_[TIPO_NODE].pid&lt;/pre&gt;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
&lt;p&gt;Caso seja necessário um arquivo de exemplo para ajudar a criar as configurações do job, utilize o comando &lt;code&gt;londiste3 \-\-ini&lt;/code&gt; para gerar um arquivo de exemplo sanar as possíveis dúvidas ou ver as configurações disponíveis.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Após o ajuste das configurações é necessário criar o nó do londiste dentro do banco a ser replicado, assim, execute o comando abaixo:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/teste_replica_root.ini create-root node1 &amp;quot;dbname=teste_replica host=192.168.152.149 user=postgres&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Inicie o daemon para o nó criado:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 -d /etc/londiste/teste_replica_root.ini worker
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;É importante lembrar que para cada novo job é necessário criar um novo arquivo de configuração e a inicialização do job no banco replicado, conforme detalhado acima.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h4 id=&#34;configure-o-daemon-do-pgq&#34;&gt;Configure o daemon do PgQ&lt;/h4&gt;

&lt;p&gt;Crie o arquivo &lt;code&gt;/etc/londiste/pgqd.ini&lt;/code&gt;, com o conteúdo abaixo:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[pgqd]
base_connstr = host=192.168.152.149 user=postgres
logfile = /var/log/londiste/pgqd.log
pidfile = /var/run/londiste/pgqd.pid
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;Caso seja necessário um arquivo de exemplo para ajudar a criar as configurações do daemon, utilize o comando &lt;code&gt;pgqd \-\-ini&lt;/code&gt; para gerar um arquivo de exemplo sanar as possíveis dúvidas ou ver as configurações disponíveis.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Inicie o daemon do PgQ:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;pgqd /etc/londiste/pgqd.ini -d
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;servidor-slave&#34;&gt;Servidor slave&lt;/h3&gt;

&lt;p&gt;Crie o arquivo &lt;code&gt;/etc/londiste/teste_replica_leaf.ini&lt;/code&gt;, com o conteúdo abaixo:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[londiste3]
job_name = teste_replica_leaf
db = dbname=teste_replica host=192.168.152.150 user=postgres
queue_name = q_teste_replica
logfile = /var/log/londiste/teste_replica_leaf.log
pidfile = /var/run/londiste/teste_replica_leaf.pid
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Crie o nó do londiste:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/teste_replica_leaf.ini create-leaf node2 &amp;quot;dbname=teste_replica host=192.168.152.150 user=postgres&amp;quot; --provider=&amp;quot;dbname=teste_replica host=192.168.152.149 user=postgres&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Inicie o worker:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 -d /etc/londiste/teste_replica_leaf.ini worker
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;criando-a-carga-de-dados-no-servidor-master&#34;&gt;Criando a carga de dados no servidor master&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;Note que não é necessário que as tabelas tenham os mesmos dados para iniciar a replicação, apenas a mesma estrutura.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Copiando os arquivos necessários para o servidor:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;scp /Users/seba/Desktop/28337_1323532011934_4739236_n.jpg root@192.168.152.149:/tmp
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ajustando as permissões:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;chown postgres:postgres /tmp/28337_1323532011934_4739236_n.jpg
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Execute a carga inicial:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;psql -U postgres -d teste_replica -f carga_inicial_londiste.sql 
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-sql&#34;&gt;
\c teste_replica

-- carga de dados
INSERT INTO pessoa (nome, data_nascimento, foto, biografia)
WITH config AS (
    SELECT 
      1000 AS max_size
)
SELECT
  &#39;Pessoa &#39; || new_id::text as nome,
  (&#39;1987-04-16&#39;::DATE + (round(CAST (random()*config.max_size AS NUMERIC),0)::TEXT || &#39; days&#39;)::INTERVAL)::DATE as data_nascimento,
  bytea_import(&#39;/tmp/28337_1323532011934_4739236_n.jpg&#39;) as foto,
  &#39;Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis tristique quam erat, in pellentesque diam feugiat in. In hac habitasse platea dictumst. Mauris malesuada faucibus diam, in tristique arcu dapibus at. Phasellus commodo nulla et orci adipiscing, quis iaculis turpis tincidunt. Proin placerat nisl non molestie porttitor. Curabitur scelerisque libero in lorem consequat consectetur ac a massa. Cras volutpat est ac lacinia ultricies. Donec quis faucibus ligula. Morbi luctus cursus lacus, a fermentum odio dignissim non. Mauris a tellus adipiscing, sodales magna sed, vehicula justo. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Nulla facilisi. Etiam eu augue nec lectus tristique bibendum vitae nec elit. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus.&#39; as biografia
FROM
  config,
  generate_series(1,config.max_size) as new_id;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;adicione-as-tabelas-a-serem-replicadas&#34;&gt;Adicione as tabelas a serem replicadas&lt;/h2&gt;

&lt;h3 id=&#34;no-servidor-master&#34;&gt;No servidor master&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/teste_replica_root.ini add-table pessoa
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;no-servidor-slave&#34;&gt;No servidor slave&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;londiste3 /etc/londiste/teste_replica_leaf.ini add-table pessoa
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;testando-a-replicação&#34;&gt;Testando a replicação&lt;/h2&gt;

&lt;p&gt;Apartir desse ponto, em alguns segundos, ambos os bancos têm os mesmos registros na tabela pessoa, veja:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@pg-slave ~]# psql -U postgres -d teste_replica -c &#39;SELECT COUNT(1) FROM pessoa;&#39; -h 192.168.152.149
 count 
-------
  1000
(1 row)

[root@pg-slave ~]# psql -U postgres -d teste_replica -c &#39;SELECT COUNT(1) FROM pessoa;&#39; -h 192.168.152.150
 count 
-------
  1000
(1 row)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Também, não é possível fazer alterações nos registros do servidor slave:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@pg-slave ~]# psql -U postgres -d teste_replica -h 192.168.152.150
psql (9.3.4)
Type &amp;quot;help&amp;quot; for help.

teste_replica=# delete from pessoa;
ERROR:  Table &#39;public.pessoa&#39; to queue &#39;q_teste_replica&#39;: change not allowed (D)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Daqui pra frente, qualquer alteração será replicada (desde que a estrutura da tabela seja a mesma).&lt;/p&gt;

&lt;p&gt;Referências:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/markokr/skytools&#34;&gt;https://github.com/markokr/skytools&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://dba.stackexchange.com/questions/1742/how-to-insert-file-data-into-a-postgresql-bytea-column&#34;&gt;http://dba.stackexchange.com/questions/1742/how-to-insert-file-data-into-a-postgresql-bytea-column&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
  </channel>
</rss>